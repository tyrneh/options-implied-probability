![OIPD logo](.meta/images/OIPD%20Logo.png)

![Python version](https://img.shields.io/badge/python-3.10-blue.svg)
[![Code Style: Black](https://img.shields.io/badge/code%20style-black-black.svg)](https://github.com/ambv/black)

This Python project generates probability density function (PDFs) and cumulative distribution functions (CDFs) for the future prices of stocks, as implied by (call) options prices. 

These probability distributions reflect market expectations but are not necessarily accurate predictions of future stock prices. 

If you believe in the efficient market hypothesis, then the probability distributions generated by this package represent the best available, risk-neutral estimates of future stock price movements, as they are derived from the collective information and expectations of market participants. They can serve as a useful tool for understanding market-implied uncertainty, skewness, and tail risks. 


<p align="center">
    <img src=".meta/images/spy.png" width="60%">
</p>


## Table of Contents

- [Installation](#installation)
- [Quick Start Guide](#Quick-Start-Guide)
- [Algorithm Overview](#algorithm-overview)
- [License](#license)


## Installation

```bash
# Core installation
pip install oipd

# For development
pip install oipd[dev]

# Install everything
pip install oipd[all]
```

Please note that this project requires Python 3.10 or later.

For more details on dependency management, see [DEPENDENCY_MANAGEMENT.md](DEPENDENCY_MANAGEMENT.md).


## Quick Start Guide

The file [`example.py`](example.py) is supplied as a demo.

### **Basic Usage**

The API uses three main components:

1. **MarketParams** - Market data (current price, dates, risk-free rate)
2. **RND** - Main estimator class
3. **ModelParams** - Optional algorithm settings

```python
from oipd import RND, MarketParams, ModelParams
from datetime import date

# 1. Define market parameters
market = MarketParams(
    current_price=39.39,
    current_date=date(2025, 3, 3),
    expiry_date=date(2025, 12, 19),
    risk_free_rate=0.04,
)

# 2. Optional: Configure model settings
model = ModelParams(fit_kde=True)  # Enable KDE smoothing

# 3. Load data and estimate RND
est = RND.from_csv(
    "path/to/options_data.csv",
    market,
    model=model,
    column_mapping={"Strike": "strike", "Last Price": "last_price", "Bid": "bid", "Ask": "ask"}
)

# 4. Create publication-ready plots
est.plot()                           # Overlay PDF and CDF
est.plot(kind="pdf")                 # PDF only
est.plot(kind="cdf")                 # CDF only

# 5. Calculate probabilities
prob = est.prob_at_or_above(45.0)    # P(price >= $45)
print(f"Probability >= $45: {prob:.1%}")

# 6. Access results
df = est.to_frame()                  # Get as pandas DataFrame
est.to_csv("results.csv")           # Save to CSV
```

### **Input Data Requirements**

Your CSV must contain at least these columns:
- `strike` - Strike prices
- `last_price` - Last traded price of options
- `bid` - Bid prices
- `ask` - Ask prices

Use `column_mapping` to match your column names to the expected format.

<b>3 examples of options data are provided in the `data/` folder, downloaded from Yahoo Finance.</b>

Note that oipd only uses call options data for now.


<b>Another interesting example is US Steel:</b>
<p align="center">
  <img src=".meta/images/ussteel.png" width="60%">
</p>
The distribution is bimodal, and given Nippon Steel's proposed $55 per share acquisition, it can be thought of as two overlapping scenarios:

1. Acquisition is approved:
   - In this scenario, the share price would likely move above the $55 per share offer. This creates a "second peak" in the distribution
   - By inspecting the cumulative prbability table (see [example.ipynb](example.ipynb)), we see there's a 33% probability that the deal is approved and price rises above $55

2. Acquisition falls apart:
   - Without the approval, the share price may drop back toward a level driven by "business as usual" fundamentals—here, that appears lower than the current $39.39. This is the "first peak" in the distribution

<i>Note that the domain (x-axis) is limited in this graph, due to (1) not many strike prices exist for US Steel, and (2) some extreme ITM/OTM options did not have solvable IVs.</i>


## Theory Overview

An option is a financial derivative that gives the holder the right, but not the obligation, to buy or sell an asset at a specified price (strike price) on a certain date in the future. Intuitively, the value of an option depends on the probability that it will be profitable or "in-the-money" at expiration. If the probability of ending "in-the-money" (ITM) is high, the option is more valuable. If the probability is low, the option is worth less.

As an example, imagine Apple stock (AAPL) is currently $150, and you buy a call option with a strike price of $160 (meaning you can buy Apple at $160 at expiration).
- If Apple is likely to rise to $170, the option has a high probability of being ITM → more valuable
- If Apple is unlikely to go above $160, the option has little chance of being ITM → less valuable

This illustrates how option prices contain information about the probabilities of the future price of the stock (as determined by market expectations). By knowing the prices of options, we can reverse-engineer and extract information contained about probabilities. 

For a simplified worked example, see this [excellent blog post](https://reasonabledeviations.com/2020/10/01/option-implied-pdfs/).
For a complete reading of the financial theory, see [this paper](https://www.bankofengland.co.uk/-/media/boe/files/quarterly-bulletin/2000/recent-developments-in-extracting-information-from-options-markets.pdf?la=en&hash=8D29F2572E08B9F2B541C04102DE181C791DB870).


## Algorithm Overview

The process of generating the PDFs and CDFs is as follows:

1. For an underlying asset, options data along the full range of strike prices are read from a CSV file to create a DataFrame. This gives us a table of strike prices along with the last price[^1] each option sold for
2. Using the Black-Sholes formula, we convert strike prices into implied volatilities (IV)[^2]. IV are solved using either Newton's Method or Brent's root-finding algorithm, as specified by the `solver_method` argument. 
3. Using B-spline, we fit a curve-of-best-fit onto the resulting IVs over the full range of strike prices[^3]. Thus, we have extracted a continuous model from discrete IV observations - this is called the volatility smile
4. From the volatility smile, we use Black-Scholes to convert IVs back to prices. Thus, we arrive at a continuous curve of options prices along the full range of strike prices
5. From the continuous price curve, we use numerical differentiation to get the first derivative of prices. Then we numerically differentiate again to get the second derivative of prices. The second derivative of prices multiplied by a discount factor $\exp^{r*\uptau}$, results in the probability density function [^4]
6. We can fit a KDE onto the resulting PDF, which in some cases will improve edge-behavior at very high or very low prices. This is specified by the argument `fit_kernal_pdf`
7. Once we have the PDF, we can calculate the CDF


[^1]: We chose to use last price instead of calculating the mid-price given the bid-ask spread. This is because Yahoo Finance, a common source for options chain data, often lacks bid-ask data. See for example [Apple options](https://finance.yahoo.com/quote/AAPL/options/)
[^2]: We convert from price-space to IV-space, and then back to price-space as described in step 4. See this [blog post](https://reasonabledeviations.com/2020/10/10/option-implied-pdfs-2/) for a breakdown of why we do this double conversion
[^3]: See [this paper](https://edoc.hu-berlin.de/bitstream/handle/18452/14708/zeng.pdf?sequence=1&isAllowed=y) for more details. In summary, options markets contains noise. Therefore, generating a volatility smile through simple interpolation will result in a noisy smile function. Then converting back to price-space will result in a noisy price curve. And finally when we numerically twice differentiate the price curve, noise will be amplified and the resulting PDF will be meaningless. Thus, we need either a parametric or non-parametric model to try to extract the true relationship between IV and strike price from the noisy observations. The paper suggests a 3rd order B-spline as a possible model choice
[^4]: For a proof of this derivation, see this [blog post](https://reasonabledeviations.com/2020/10/10/option-implied-pdfs-2/)


## Feedback and Contributing

Feedback is most welcome! I'd love to hear about how you make use of this information, what are the use cases, and what further features you want to see. Email me at tyrneh@gmail.com to chat. 

Contributions are also welcome. Please fork the repository, make your changes, and submit a pull request.

## Roadmap

The methodology in this package is a basic implementation, and more rigour is necessary for professional use. I will work on these features when I have free time, and contributions to the following would be welcome:

1. Dividend handling in the current Black-Scholes Model

2. Improved support for American options
   - Currently, all options are assumed to be European for simplicity. To better support American options:
      - Implement a method to "de-Americanize" American options in order to be compatible with the existing Black-Scholes implementation, or
      - Add an American options pricing model. However with an American model, the current method (using the second derivative to derive the probability density function) is no longer valid, so a new approach would need to be discovered

3. Integration of alternative pricing models
   - Offer the choice among different models, including the following suggestions from users:
      - Heston
      - Jump-Diffusion
      - Binomial Tree

## License

DISCLAIMER: This software is provided for informational and educational purposes only and does not constitute financial advice. Use it at your own risk. The author is not responsible for any financial losses or damages resulting from its use. Always consult with a qualified financial professional before making any financial decisions.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
